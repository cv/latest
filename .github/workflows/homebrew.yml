# Update Homebrew tap when a release is published
name: Update Homebrew Tap

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: true

jobs:
  update-tap:
    # Skip prereleases (only applies to release events)
    if: ${{ github.event_name == 'workflow_dispatch' || !github.event.release.prerelease }}
    runs-on: ubuntu-22.04
    steps:
      - name: Update Homebrew tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag || github.event.release.tag_name }}
        run: |
          # Download the generated formula from the release
          curl -sL "https://github.com/cv/latest/releases/download/${TAG}/latest.rb" -o latest.rb
          
          # Clone the tap repo
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/cv/homebrew-tap.git" tap
          cd tap
          
          # Update the formula
          cp ../latest.rb Formula/latest.rb
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/latest.rb
          git commit -m "Update latest to ${TAG}"
          git push
